trigger:
  branches:
    exclude:
      - main
  paths:
    include:
      - '**/*.bim'
      - '**/*.tmdl'

pr:
  branches:
    include:
      - main
  paths:
    include:
      - '**/*.bim'
      - '**/*.tmdl'

# Reference the variable group
variables:
- group: 'PowerBI-Rules-Paths'

pool:
  vmImage: 'windows-latest'

stages:
- stage: Build
  displayName: 'Build and Test All Datasets'
  jobs:
  - job: Build_Datasets
    displayName: 'Analyze All Datasets'
    steps:
      - checkout: self
        path: 'self'
        persistCredentials: true
        fetchDepth: 0  # Fetch full history for git diff
        
      - task: PowerShell@2
        displayName: 'Download Tabular Editor'
        inputs:
          targetType: inline
          script: |     
            $path = "$(Build.SourcesDirectory)"                       
            $tempPath = Join-Path $path '_temp'
            $toolPath = Join-Path $path '_tools\TE'
            New-Item -ItemType Directory -Path $tempPath -ErrorAction SilentlyContinue | Out-Null
            New-Item -ItemType Directory -Path $toolPath -ErrorAction SilentlyContinue | Out-Null
            
            Write-Host "##[debug]Downloading Tabular Editor binaries"
            $downloadUrl = "https://github.com/TabularEditor/TabularEditor/releases/latest/download/TabularEditor.Portable.zip"
            $zipFile = Join-Path $tempPath 'TabularEditor.zip'
            Invoke-WebRequest -Uri $downloadUrl -OutFile $zipFile
            Expand-Archive -Path $zipFile -DestinationPath $toolPath -Force

      - task: PowerShell@2
        displayName: 'Verify BPA Rules File'
        inputs:
          targetType: inline
          script: |
            $path = "$(Build.SourcesDirectory)"
            # Use the variable from the variable group
            $rulesPath = Join-Path $path "$(te_bpa_standard_rules)"
            
            if (!(Test-Path $rulesPath)) {
              Write-Error "BPA rules file not found at $rulesPath"
              exit 1
            }
            Write-Host "Using BPA rules: $rulesPath"

      - task: PowerShell@2
        displayName: 'Identify Changed Dataset Files'
        inputs:
          targetType: inline
          script: |
            cd "$(Build.SourcesDirectory)"
            $path = "$(Build.SourcesDirectory)"
            
            Write-Host "##[section]Comparing HEAD with origin/main to find changed dataset files..."
            
            # Fetch latest
            git fetch origin main --quiet
            
            # Get changed files - different approach for PR vs branch push
            if ("$(Build.Reason)" -eq "PullRequest") {
                $changedFiles = git diff --name-only origin/main...HEAD
            } else {
                $changedFiles = git diff --name-only origin/main HEAD
            }

            if (-not $changedFiles) {
              Write-Host "##[warning]No files changed."
              Write-Host "##vso[task.setvariable variable=HasChangedModels]false"
              exit 0
            }

            Write-Host "Changed files:"
            $changedFiles | ForEach-Object { Write-Host "  - $_" }

            # Filter for dataset files
            $filteredFiles = $changedFiles | Where-Object {
              $_ -like '*.bim' -or $_ -like '*.tmdl'
            }

            if (-not $filteredFiles) {
              Write-Host "##[warning]No dataset files (.bim or .tmdl) changed."
              Write-Host "##vso[task.setvariable variable=HasChangedModels]false"
              exit 0
            }

            Write-Host "##[section]Dataset files changed:"
            $filteredFiles | ForEach-Object { Write-Host "  - $_" }
            
            # Identify parent model folders/files
            $modelPaths = @()
            
            foreach ($file in $filteredFiles) {
                # If a .tmdl file is changed, find the parent model folder
                if ($file -like '*.tmdl') {
                    if ($file -match '^(.*\.(pbidataset|pbism|SemanticModel))') {
                        $modelFolder = $matches[1]
                        $fullModelPath = Join-Path $path $modelFolder
                        
                        if ((Test-Path $fullModelPath) -and $modelPaths -notcontains $modelFolder) {
                            $modelPaths += $modelFolder
                            Write-Host "  â†’ Will analyze model folder: $modelFolder"
                        }
                    }
                    else {
                        Write-Warning "Could not extract model folder from $file"
                    }
                }
                # Standalone .bim files or .bim inside dataset folders
                elseif ($file -like '*.bim') {
                    # Check if it's inside a model folder
                    if ($file -match '^(.*\.(pbidataset|pbism|SemanticModel))') {
                        $modelFolder = $matches[1]
                        $fullModelPath = Join-Path $path $modelFolder
                        
                        if ((Test-Path $fullModelPath) -and $modelPaths -notcontains $modelFolder) {
                            $modelPaths += $modelFolder
                            Write-Host "  â†’ Will analyze model folder: $modelFolder"
                        }
                    }
                    else {
                        # Standalone .bim file
                        if ($modelPaths -notcontains $file) {
                            $modelPaths += $file
                            Write-Host "  â†’ Will analyze standalone .bim: $file"
                        }
                    }
                }
            }
            
            if ($modelPaths.Count -eq 0) {
              Write-Host "##[warning]No models to analyze after filtering."
              Write-Host "##vso[task.setvariable variable=HasChangedModels]false"
              exit 0
            }
            
            # Store the models to analyze as a semicolon-separated string
            $modelsString = $modelPaths -join ";"
            Write-Host "##vso[task.setvariable variable=ModelsToAnalyze]$modelsString"
            Write-Host "##vso[task.setvariable variable=HasChangedModels]true"
            Write-Host "##[section]Total models to analyze: $($modelPaths.Count)"

      - task: PowerShell@2
        displayName: 'Run Dataset Rules on Changed Models'
        condition: eq(variables['HasChangedModels'], 'true')
        inputs:
          targetType: inline
          script: |
            $path = "$(Build.SourcesDirectory)"
            $toolPath = Join-Path $path '_tools\TE\TabularEditor.exe'
            # Use the variable from the variable group
            $rulesPath = Join-Path $path "$(te_bpa_standard_rules)"

            # Get the models to analyze from the previous step (semicolon-separated)
            $modelsString = "$(ModelsToAnalyze)"
            
            if ([string]::IsNullOrWhiteSpace($modelsString)) {
              Write-Host "##[warning]No models to analyze."
              exit 0
            }
            
            $modelsToAnalyzePaths = $modelsString -split ";"
            
            if (-not $modelsToAnalyzePaths -or $modelsToAnalyzePaths.Count -eq 0) {
              Write-Host "##[warning]No models to analyze."
              exit 0
            }

            Write-Host "##[section]Analyzing $($modelsToAnalyzePaths.Count) changed model(s)"

            # Arrays to track results
            $passedModels = @()
            $failedModels = @()

            foreach ($modelPath in $modelsToAnalyzePaths) {
              # Get the full path
              $fullModelPath = Join-Path $path $modelPath
              
              if (-not (Test-Path $fullModelPath)) {
                Write-Warning "Model path not found: $fullModelPath"
                continue
              }
              
              $item = Get-Item $fullModelPath
              $modelName = $item.Name
              $itemPath = $null
              
              # Determine if this is a directory or file
              if ($item.PSIsContainer) {
                # It's a directory (.pbidataset, .pbism, or .SemanticModel)
                $modelFolder = $item.FullName
                
                # Try TMDL format first (definition folder)
                $tmdlPath = Join-Path $modelFolder "definition"
                if (Test-Path $tmdlPath) {
                  $itemPath = $tmdlPath
                }
                else {
                  # Fallback to BIM format
                  $bimPath = Join-Path $modelFolder "model.bim"
                  if (Test-Path $bimPath) {
                    $itemPath = $bimPath
                  }
                }
                
                if (-not $itemPath) {
                  Write-Warning "Cannot find model definition (definition folder or model.bim) in $($item.FullName)"
                  continue
                }
              }
              else {
                # It's a standalone .bim file
                $itemPath = $item.FullName
              }

              Write-Host "##[group]Running BPA for: '$modelName'"
              Write-Host "  Model path: $itemPath"

              $process = Start-Process -FilePath $toolPath -ArgumentList """$itemPath"" -A ""$rulesPath"" -V" -NoNewWindow -Wait -PassThru

              if ($process.ExitCode -ne 0) {
                Write-Host "##[error]BPA validation failed for: $modelName"
                $failedModels += [PSCustomObject]@{
                  Name = $modelName
                  Path = $itemPath
                }
              }
              else {
                Write-Host "##[command]BPA validation passed for: $modelName"
                $passedModels += [PSCustomObject]@{
                  Name = $modelName
                  Path = $itemPath
                }
              }

              Write-Host "##[endgroup]"
            }

            # Print summary
            Write-Host ""
            Write-Host "##[section]=========================================="
            Write-Host "##[section]BPA VALIDATION SUMMARY"
            Write-Host "##[section]=========================================="
            Write-Host ""
            Write-Host "Total models analyzed: $($passedModels.Count + $failedModels.Count)"
            Write-Host "Models passed: $($passedModels.Count)"
            Write-Host "Models failed: $($failedModels.Count)"
            Write-Host ""

            if ($passedModels.Count -gt 0) {
              Write-Host "##[section]âœ“ PASSED MODELS ($($passedModels.Count)):"
              Write-Host "##[section]----------------------------------------"
              foreach ($model in $passedModels) {
                Write-Host "##[command]  âœ“ $($model.Name)" -ForegroundColor Green
                Write-Host "     Path: $($model.Path)"
              }
              Write-Host ""
            }

            if ($failedModels.Count -gt 0) {
              Write-Host "##[section]âœ— FAILED MODELS ($($failedModels.Count)):"
              Write-Host "##[section]----------------------------------------"
              foreach ($model in $failedModels) {
                Write-Host "##[error]  âœ— $($model.Name)"
                Write-Host "     Path: $($model.Path)"
              }
              Write-Host ""
            }

            Write-Host "##[section]=========================================="

            if ($failedModels.Count -gt 0) {
              Write-Error "$($failedModels.Count) model(s) failed BPA validation. Please review the errors above."
              exit 1
            }
            else {
              Write-Host "##[command]All models passed BPA validation! ðŸŽ‰" -ForegroundColor Green
            }